<!DOCTYPE html>

<html>

    <head>
        <title>Metadata</title>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <meta charset='UTF-8'>
        <script src='metadata.js'></script> 
        <script src='base64.js'></script> 
        <style>
            html {
                margin: 0px;
                padding: 0px;
            }
            body {
                margin: 0px;
                padding: 32px;
                background: #404040;
                font-family: Open Sans;
                font-weigth: 400;
                font-size: 12px;
                color: #ffffff;
            }
            .table {
                border-collapse: collapse;
            }
            .table td, #table th {
                border: 1px solid white;
                white-space: nowrap;
                padding: 2px 8px 2px 8px;
            }
            a {
                color: #637ceb;
            }
            .header {
                margin-top: 48px;
                margin-bottom: 16px;
                font-size: 14px;
                font-weight: 700;
                text-transform: uppercase;
            }
        </style>
    </head>
    
    <body>
        <script>
            function linkId(id) {
                return '<a href="http://www.awaresystems.be/imaging/tiff/tifftags/search.html?q=' + id + '">' + id + '</a>';
            }
        
            function emitTagTable(list, table) {
                for (var i = 0; i < list.length; i++) {
                     var row = table.insertRow();
                     var cell0 = row.insertCell(0);
                     var cell1 = row.insertCell(1);
                     var cell2 = row.insertCell(2);
                     var cell3 = row.insertCell(3);
                     cell0.innerHTML = list[i].path;
                     cell1.innerHTML = linkId(list[i].tag.id);
                     var type = '';
                     switch (list[i].tag.type) {
                        case MD.TIFF_TYPE_BYTE: type = 'BYTE'; break;
                        case MD.TIFF_TYPE_ASCII: type = 'ASCII'; break;
                        case MD.TIFF_TYPE_SHORT: type = 'SHORT'; break;
                        case MD.TIFF_TYPE_LONG: type = 'LONG'; break;
                        case MD.TIFF_TYPE_RATIONAL: type = 'RATIONAL'; break;
                        case MD.TIFF_TYPE_SBYTE: type = 'SBYTE'; break;
                        case MD.TIFF_TYPE_UNDEFINED: type = 'UNDEFINED'; break;
                        case MD.TIFF_TYPE_SSHORT: type = 'SSHORT'; break;
                        case MD.TIFF_TYPE_SLONG: type = 'SLONG'; break;
                        case MD.TIFF_TYPE_SRATIONAL: type = 'SRATIONAL'; break;
                        case MD.TIFF_TYPE_FLOAT: type = 'FLOAT'; break;
                        case MD.TIFF_TYPE_DOUBLE: type = 'DOUBLE'; break;
                        case MD.TIFF_TYPE_IFD: type = 'IFD'; break;
                        default: type = 'Unknown (' + list[i].tag.type + ')'; break;
                     }
                     cell2.innerHTML = type;
                     var dataToShow = '';
                     var data = list[i].tag.data;
                     if (data instanceof Array) {
                        var showCount = 8;
                        var truncate = data.length > showCount;
                        for (var j = 0; j < Math.min(data.length, showCount); j++) {
                            dataToShow += data[j];
                            if (j < data.length) {
                                dataToShow += ', ';
                            }
                        }
                        if (truncate) {
                            dataToShow += '(' + (data.length - showCount) + ' more)';
                        }
                     } else {
                        dataToShow = data;
                     }
                     cell3.innerHTML = dataToShow;
                }
            }
            
            function emitDataTable(data, table) {
                for (var path in data) {
                    var dataForPath = data[path];
                    for (var i = 0; i < dataForPath.length; i++) {
                        var dataForTag = dataForPath[i];
                        for (var j = 0; j < dataForTag.data.length; j++) {
                            
                            var row = table.insertRow();
                            var cell0 = row.insertCell(0);
                            var cell1 = row.insertCell(1);
                            var cell2 = row.insertCell(2);
                            var cell3 = row.insertCell(3);
                            var cell4 = row.insertCell(4);
                            
                            cell0.innerHTML = path;
                            cell1.innerHTML = (dataForTag.data[j].byteLength / 1024).toFixed(1) + 'KB';
                            cell2.innerHTML = linkId(dataForTag.positionTag.id);
                            cell3.innerHTML = linkId(dataForTag.lengthTag.id);
                            
                            var uint8 = new Uint8Array(dataForTag.data[j]);
                            if (uint8[0] == 0xff && uint8[1] == 0xd8 && uint8[2] == 0xff && uint8[3] != 0xc3) {
                                (function(buffer, cell) {
                                    var worker = new Worker('worker.js');
                                    worker.onmessage = function(msg) {
                                        var div = document.createElement('div');
                                        div.innerHTML = 'Loading...';
                                        cell.appendChild(div);
                                        var im = document.createElement('img');
                                        im.onload = function() {
                                            cell.removeChild(div);
                                            cell.appendChild(im);
                                            div.innerHTML = im.width + ' x ' + im.height;
                                            cell.appendChild(div);
                                            im.style.width = Math.min(im.width, 640) + 'px';
                                        }
                                        im.onerror = function() {
                                            cell.removeChild(div);
                                        }
                                        im.src = 'data:image/jpg;base64,' + msg.data;
                                    }
                                    worker.postMessage(uint8);
                                })(uint8, cell4);
                            }
                        }
                    }
                }
            }
        
            var file = 'im.jpg';
            MD.get(file, 
                function(buffer) {
                    var tiffBuffer = null;
                    if (file.endsWith('.jpg')) {
                        var jpeg = new MD.Jpeg(buffer);
                        tiffBuffer = jpeg.getExifBuffer();
                    } else {
                        tiffBuffer = buffer;
                    }
                    var tiff = new MD.Tiff(tiffBuffer);
                    var list = tiff.enumerate();                    
                    emitTagTable(list, document.getElementById('tagTable'));
                    emitDataTable(tiff.data, document.getElementById('dataTable'));
                    
                    var encoded = tiff.save(MD.LITTLE_ENDIAN);
                    console.log(encoded);
                },
                function() {
                    throw 'Failed to fetch image';
                })
        
        </script>
        
        <div class='header' style='margin-top: 0px';>TIFF/EXIF Tags</div>
        <table id='tagTable' class='table'></table>
        <div class='header'>TIFF/EXIF Referenced Data</div>
        <table id='dataTable' class='table'></table>
    </body>

</html>