<!DOCTYPE html>

<html>

    <head>
        <title>Metadata</title>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <meta charset='UTF-8'>
        <script src='metadata.js'></script> 
        <style>
            html {
                margin: 0px;
                padding: 0px;
            }
            body {
                margin: 0px;
                padding: 32px;
                background: #404040;
                font-family: Open Sans;
                font-weigth: 400;
                font-size: 12px;
                color: #ffffff;
            }
            .table {
                border-collapse: collapse;
            }
            .table td, #table th {
                border: 1px solid white;
                white-space: nowrap;
                padding: 2px 8px 2px 8px;
            }
            a {
                color: #637ceb;
            }
            .header {
                margin-top: 48px;
                margin-bottom: 16px;
                font-size: 14px;
                font-weight: 700;
                text-transform: uppercase;
            }
        </style>
    </head>
    
    <body>
        <script>
            function uint8ToBase64 (uint8) {
                var lookup = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
                var i
                var extraBytes = uint8.length % 3 // if we have 1 byte left, pad 2 bytes
                var output = ''
                var temp, length

                function encode (num) {
                  return lookup.charAt(num)
                }

                function tripletToBase64 (num) {
                  return encode(num >> 18 & 0x3F) + encode(num >> 12 & 0x3F) + encode(num >> 6 & 0x3F) + encode(num & 0x3F)
                }

                // go through the array every three bytes, we'll deal with trailing stuff later
                for (i = 0, length = uint8.length - extraBytes; i < length; i += 3) {
                  temp = (uint8[i] << 16) + (uint8[i + 1] << 8) + (uint8[i + 2])
                  output += tripletToBase64(temp)
                }

                // pad the end with zeros, but make sure to not forget the extra bytes
                switch (extraBytes) {
                  case 1:
                    temp = uint8[uint8.length - 1]
                    output += encode(temp >> 2)
                    output += encode((temp << 4) & 0x3F)
                    output += '=='
                    break
                  case 2:
                    temp = (uint8[uint8.length - 2] << 8) + (uint8[uint8.length - 1])
                    output += encode(temp >> 10)
                    output += encode((temp >> 4) & 0x3F)
                    output += encode((temp << 2) & 0x3F)
                    output += '='
                    break
                  default:
                    break
                }

                return output
            }

            function linkId(id) {
                return '<a href="http://www.awaresystems.be/imaging/tiff/tifftags/search.html?q=' + id + '">' + id + '</a>';
            }
        
            function emitTagTable(list, table) {
                for (var i = 0; i < list.length; i++) {
                     var row = table.insertRow();
                     var cell0 = row.insertCell(0);
                     var cell1 = row.insertCell(1);
                     var cell2 = row.insertCell(2);
                     var cell3 = row.insertCell(3);
                     cell0.innerHTML = list[i].path;
                     cell1.innerHTML = linkId(list[i].tag.id);
                     var type = '';
                     switch (list[i].tag.type) {
                        case MD.TIFF_TYPE_BYTE: type = 'BYTE'; break;
                        case MD.TIFF_TYPE_ASCII: type = 'ASCII'; break;
                        case MD.TIFF_TYPE_SHORT: type = 'SHORT'; break;
                        case MD.TIFF_TYPE_LONG: type = 'LONG'; break;
                        case MD.TIFF_TYPE_RATIONAL: type = 'RATIONAL'; break;
                        case MD.TIFF_TYPE_SBYTE: type = 'SBYTE'; break;
                        case MD.TIFF_TYPE_UNDEFINED: type = 'UNDEFINED'; break;
                        case MD.TIFF_TYPE_SSHORT: type = 'SSHORT'; break;
                        case MD.TIFF_TYPE_SLONG: type = 'SLONG'; break;
                        case MD.TIFF_TYPE_SRATIONAL: type = 'SRATIONAL'; break;
                        case MD.TIFF_TYPE_FLOAT: type = 'FLOAT'; break;
                        case MD.TIFF_TYPE_DOUBLE: type = 'DOUBLE'; break;
                        case MD.TIFF_TYPE_IFD: type = 'IFD'; break;
                        default: type = 'Unknown (' + list[i].tag.type + ')'; break;
                     }
                     cell2.innerHTML = type;
                     var dataToShow = '';
                     var data = list[i].tag.data;
                     if (data instanceof Array) {
                        var showCount = 8;
                        var truncate = data.length > showCount;
                        for (var j = 0; j < Math.min(data.length, showCount); j++) {
                            dataToShow += data[j];
                            if (j < data.length) {
                                dataToShow += ', ';
                            }
                        }
                        if (truncate) {
                            dataToShow += '(' + (data.length - showCount) + ' more)';
                        }
                     } else {
                        dataToShow = data;
                     }
                     cell3.innerHTML = dataToShow;
                }
            }
            
            function emitDataTable(data, table) {
                for (var path in data) {
                    var dataForPath = data[path];
                    for (var i = 0; i < dataForPath.length; i++) {
                        var dataForTag = dataForPath[i];
                        for (var j = 0; j < dataForTag.data.length; j++) {
                            
                            (function(dataForTag, j) {
                            
                                var row = table.insertRow();
                                var cell0 = row.insertCell(0);
                                var cell1 = row.insertCell(1);
                                var cell2 = row.insertCell(2);
                                var cell3 = row.insertCell(3);
                                var cell4 = row.insertCell(4);
                            
                                var buffer = dataForTag.data[j];
                                var im = new Image();
                                var base64 = uint8ToBase64(new Uint8Array(buffer))
                                im.onload = function() {
                                    var div = document.createElement('div');
                                    div.innerHTML = im.width + ' x ' + im.height;
                                    im.style.width = '640px';
                                    cell4.appendChild(im);
                                    cell4.appendChild(div);
                                    
                                }
                                im.src = 'data:image/jpg;base64,' + base64;
                                
                                cell0.innerHTML = path;
                                cell1.innerHTML = (buffer.byteLength / 1024).toFixed(1) + 'KB';
                                cell2.innerHTML = linkId(dataForTag.positionTag.id);
                                cell3.innerHTML = linkId(dataForTag.lengthTag.id);
                            })(dataForTag, j);
                            
                        }
                    }
                }
            }
        
            var file = 'im.nef';
            MD.get(file, 
                function(buffer) {
                    var tiffBuffer = null;
                    if (file.endsWith('.jpg')) {
                        var jpeg = new MD.Jpeg(buffer);
                        tiffBuffer = jpeg.getExifBuffer();
                    } else {
                        tiffBuffer = buffer;
                    }
                    var tiff = new MD.Tiff(tiffBuffer);
                    var list = tiff.enumerate();
                    emitTagTable(list, document.getElementById('tagTable'));
                    emitDataTable(tiff.data, document.getElementById('dataTable'));
                    

                },
                function() {
                    throw 'Failed to fetch image';
                })
        
        </script>
        
        <div class='header' style='margin-top: 0px';>Tag Table</div>
        <table id='tagTable' class='table'></table>
        <div class='header'>Data Table</div>
        <table id='dataTable' class='table'></table>
    </body>

</html>